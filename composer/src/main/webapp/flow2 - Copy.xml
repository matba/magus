<!-- process1 BPEL Process [Generated by the MAGUS Mashup tool]  -->

<bpel:process name="process1"
         targetNamespace="http://magus.online/mf/orderprocessing/wsdl/process1"
         suppressJoinFailure="yes"
         xmlns:tns="http://magus.online/mf/orderprocessing/wsdl/process1"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         >
    <!-- Import the client WSDL -->
	<bpel:import location="process1Artifacts.wsdl" namespace="http://magus.online/mf/orderprocessing/wsdl/process1" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	        
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->         
    <bpel:partnerLinks>
        <!--
        The 'client' role represents the requester of this service. It is 
        used for callback. The location and correlation information associated
        with the client role are automatically set using WS-Addressing.
        -->
        
    <bpel:partnerLink myRole="purchaseService" name="purchasing" partnerLinkType="tns:purchasingLT"/>
    <bpel:partnerLink myRole="invoiceRequester" name="invoicing" partnerLinkType="tns:invoicingLT" partnerRole="invoiceService"/>
    <bpel:partnerLink myRole="shippingRequester" name="shipping" partnerLinkType="tns:shippingLT" partnerRole="shippingService"/>
    <bpel:partnerLink name="scheduling" partnerLinkType="tns:schedulingLT" partnerRole="schedulingService"/>
 	<bpel:partnerLink name="taxCalculationPR" partnerLinkType="tns:taxLT" myRole="taxRequester" partnerRole="taxService" />
    </bpel:partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->         
    <bpel:variables> 
       <bpel:variable messageType="tns:poMessage" name="po"/>
	   <bpel:variable messageType="tns:InvMessage" name="i"/>
	   <bpel:variable messageType="tns:orderFaultType" name="poFault"/>
	   <bpel:variable messageType="tns:shippingRequestMessage" name="shippingRequest"/>
	   <bpel:variable messageType="tns:shippingInfoMessage" name="f"/>
	   <bpel:variable messageType="tns:scheduleMessage" name="s"/>
	   <bpel:variable messageType="tns:productionMessage" name="p"/>
	   <bpel:variable messageType="tns:TaxInfoMessage" name="t"></bpel:variable>
	<bpel:variable messageType="tns:OrderPurchases" name="purchases"/>
    </bpel:variables>
	<bpel:faultHandlers>
    <bpel:catch faultMessageType="tns:orderFaultType" faultName="tns:cannotCompleteOrder" faultVariable="poFault">
      <bpel:reply faultName="bpel:cannotCompleteOrder" operation="sendPurchaseOrder" partnerLink="purchasing" portType="tns:purchaseOrderPT" variable="poFault"/>
    </bpel:catch>
  </bpel:faultHandlers>
    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    <bpel:sequence name="main">
    		<bpel:receive operation="sendPurchaseOrder" partnerLink="purchasing" portType="tns:purchaseOrderPT" variable="po" createInstance="yes" />
			 <bpel:assign validateXML="no">
		          <bpel:copy>
		            <bpel:from part="customerInfo" variable="po" />
		            <bpel:to part="customerInfo" variable="shippingRequest" />
		          </bpel:copy>
		        </bpel:assign>
			 <bpel:invoke inputVariable="po" operation="initiatePriceCalculation" partnerLink="invoicing" portType="tns:computePricePT" />      
		    <bpel:flow>
		      <bpel:documentation>
		          A parallel flow to handle shipping, invoicing and scheduling
		      </bpel:documentation>
		      <bpel:links>
		        
		        <bpel:link name="ship-to-scheduling" />
		   
		      </bpel:links>
			    
			   <bpel:sequence>
                <bpel:assign validateXML="no"><bpel:copy>
		            <bpel:from part="purchaseOrder" variable="po" />
		            <bpel:to part="purchaseOrder" variable="purchases" />
		        </bpel:copy>
                </bpel:assign>
                <bpel:invoke inputVariable="po" operation="calculateTaxforOrder" partnerLink="taxCalculationPR" portType="tns:taxCalcuationPT" />
                <bpel:receive operation="calculateTaxforOrder" partnerLink="taxCalculationPR" portType="tns:taxCalcuationCallbackPT" variable="t" >
		        </bpel:receive>
		        <bpel:invoke inputVariable="t" operation="sendTaxInfo" partnerLink="invoicing" portType="tns:computePricePT">
			        
			    </bpel:invoke>
		        
            </bpel:sequence>
		      
		      <bpel:sequence>
		        <bpel:invoke inputVariable="po" operation="requestProductionScheduling" partnerLink="scheduling" portType="tns:schedulingPT" />
				<bpel:receive operation="requestProductionScheduling" partnerLink="scheduling" portType="tns:schedulingCallbackPT" variable="p">
		          <bpel:sources>
		            <bpel:source linkName="ship-to-scheduling" />
		          </bpel:sources>
		        </bpel:receive>
		        <bpel:invoke inputVariable="p" operation="sendShippingSchedule" partnerLink="scheduling" portType="tns:schedulingPT">
		          
		        </bpel:invoke>
		      </bpel:sequence>
		     <bpel:sequence>
		       
		        <bpel:invoke inputVariable="po" operation="requestEligibleShipping" outputVariable="co" partnerLink="eligibleshipping" portType="tns:eligibleshippingPT">
		          
		        </bpel:invoke>
			<bpel:invoke inputVariable="p" operation="requestShipping" outputVariable="s" partnerLink="shipping" portType="tns:shippingPT">
		          <bpel:targets>
		            <bpel:target linkName="ship-to-scheduling" />
		          </bpel:targets>
		        </bpel:invoke>
			
		       
		         <bpel:invoke inputVariable="s" operation="sendShippingSchedule" partnerLink="invoicing" portType="tns:sendSchedulePT">
			       
			        </bpel:invoke>
		      </bpel:sequence>
		    </bpel:flow>
			 <bpel:receive operation="initiatePriceCalculation" partnerLink="invoicing" portType="tns:invoiceCallbackPT" variable="i">
			 </bpel:receive>
		    <bpel:reply operation="sendPurchaseOrder" partnerLink="purchasing" portType="tns:purchaseOrderPT" variable="i" />
    </bpel:sequence>
</bpel:process>


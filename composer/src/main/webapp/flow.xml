<!-- process1 BPEL Process [Generated by the MAGUS Mashup tool]  -->

<bpel:process name="process1"
         targetNamespace="http://bashari.ca/magus/mf/orderprocessing/wsdl/process1"
         suppressJoinFailure="yes"
         xmlns:tns="http://bashari.ca/magus/mf/orderprocessing/wsdl/process1"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         >
    <!-- Import the client WSDL -->
	<bpel:import location="process1Artifacts.wsdl" namespace="http://bashari.ca/magus/mf/orderprocessing/wsdl/process1"
	        importType="http://schemas.xmlsoap.org/wsdl/" />

    <!-- ================================================================= -->
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->
    <bpel:partnerLinks>
        <!--
        The 'client' role represents the requester of this service. It is
        used for callback. The location and correlation information associated
        with the client role are automatically set using WS-Addressing.
        -->

    <bpel:partnerLink myRole="purchaseService" name="purchasing" partnerLinkType="tns:purchasingLT"/>
    <bpel:partnerLink myRole="invoiceRequester" name="invoicing" partnerLinkType="tns:invoicingLT" partnerRole="invoiceService"/>
    <bpel:partnerLink myRole="shippingRequester" name="shipping" partnerLinkType="tns:shippingLT" partnerRole="shippingService"/>
    <bpel:partnerLink name="scheduling" partnerLinkType="tns:schedulingLT" partnerRole="schedulingService"/>
 	<bpel:partnerLink name="taxCalculationPR" partnerLinkType="tns:taxLT" myRole="taxRequester" partnerRole="taxService" />
    </bpel:partnerLinks>

    <!-- ================================================================= -->
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->
    <bpel:variables>
       <bpel:variable messageType="tns:POMessage" name="PO"/>
	   <bpel:variable messageType="tns:InvMessage" name="Invoice"/>
	   <bpel:variable messageType="tns:orderFaultType" name="POFault"/>
	   <bpel:variable messageType="tns:shippingRequestMessage" name="shippingRequest"/>
	   <bpel:variable messageType="tns:shippingInfoMessage" name="shippingInfo"/>
	   <bpel:variable messageType="tns:scheduleMessage" name="shippingSchedule"/>
	   <bpel:variable messageType="tns:TaxInfoMessage" name="taxInfo"></bpel:variable>
	<bpel:variable messageType="tns:OrderPurchases" name="purchases"/>
    </bpel:variables>
	<bpel:faultHandlers>
    <bpel:catch faultMessageType="tns:orderFaultType" faultName="tns:cannotCompleteOrder" faultVariable="POFault">
      <bpel:reply faultName="bpel:cannotCompleteOrder" operation="sendPurchaseOrder" partnerLink="purchasing" portType="tns:purchaseOrderPT" variable="POFault"/>
    </bpel:catch>
  </bpel:faultHandlers>
    <!-- ================================================================= -->
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->
    <bpel:sequence name="main">
    		<bpel:receive operation="sendPurchaseOrder" partnerLink="purchasing" portType="tns:purchaseOrderPT" variable="PO" createInstance="yes" />
		    <bpel:flow>
		      <bpel:documentation>
		          A parallel flow to handle shipping, invoicing and scheduling
		      </bpel:documentation>
		      <bpel:links>
		        <bpel:link name="ship-to-invoice" />
		        <bpel:link name="ship-to-scheduling" />
		        <bpel:link name="tax-to-invoice" />
		      </bpel:links>
		      <bpel:sequence>
		        <bpel:assign validateXML="no">
		          <bpel:copy>
		            <bpel:from part="customerInfo" variable="PO" />
		            <bpel:to part="customerInfo" variable="shippingRequest" />
		          </bpel:copy>
		        </bpel:assign>
		        <bpel:invoke inputVariable="shippingRequest" operation="requestShipping" outputVariable="shippingInfo" partnerLink="shipping" portType="tns:shippingPT">

		        </bpel:invoke>
		        <bpel:receive operation="requestShipping" partnerLink="shipping" portType="tns:shippingCallbackPT" variable="shippingSchedule">
		          <bpel:sources>
		            <bpel:source linkName="ship-to-scheduling" />
		          </bpel:sources>
		        </bpel:receive>
		         <bpel:invoke inputVariable="shippingInfo" operation="sendShippingPrice" partnerLink="invoicing" portType="tns:computePricePT">
			          <bpel:sources>
		            <bpel:source linkName="ship-to-invoice" />
		          </bpel:sources>
			        </bpel:invoke>
		      </bpel:sequence>
		      <bpel:sequence>
		        <bpel:invoke inputVariable="PO" operation="initiatePriceCalculation" partnerLink="invoicing" portType="tns:computePricePT" />
                <bpel:receive operation="initiatePriceCalculation" partnerLink="invoicing" portType="tns:invoiceCallbackPT" variable="Invoice"><bpel:targets>
	                		<bpel:target linkName="tax-to-invoice" />
				            <bpel:target linkName="ship-to-invoice" />
				    </bpel:targets>
                </bpel:receive>
            </bpel:sequence>
		      <bpel:sequence>
		        <bpel:invoke inputVariable="PO" operation="requestProductionScheduling" partnerLink="scheduling" portType="tns:schedulingPT" />
		        <bpel:invoke inputVariable="shippingSchedule" operation="sendShippingSchedule" partnerLink="scheduling" portType="tns:schedulingPT">
		          <bpel:targets>
		            <bpel:target linkName="ship-to-scheduling" />
		          </bpel:targets>
		        </bpel:invoke>
		      </bpel:sequence>
		      <bpel:sequence>
                <bpel:assign validateXML="no"><bpel:copy>
		            <bpel:from part="purchaseOrder" variable="PO" />
		            <bpel:to part="purchaseOrder" variable="purchases" />
		        </bpel:copy>
                </bpel:assign>
                <bpel:invoke inputVariable="purchases" operation="calculateTaxforOrder" partnerLink="taxCalculationPR" portType="tns:taxCalcuationPT" />
                <bpel:receive operation="calculateTaxforOrder" partnerLink="taxCalculationPR" portType="tns:taxCalcuationCallbackPT" variable="taxInfo" >
		        </bpel:receive>
		        <bpel:invoke inputVariable="taxInfo" operation="sendTaxInfo" partnerLink="invoicing" portType="tns:computePricePT">
			        <bpel:sources>
		            <bpel:source linkName="tax-to-invoice" />
		          </bpel:sources>
			    </bpel:invoke>

            </bpel:sequence>
		    </bpel:flow>
		    <bpel:reply operation="sendPurchaseOrder" partnerLink="purchasing" portType="tns:purchaseOrderPT" variable="Invoice" />
    </bpel:sequence>
</bpel:process>

